<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基金详情测试</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: #f5f7fa;
            color: #303133;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #409EFF;
        }
        .info-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .info-item {
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .info-label {
            font-size: 12px;
            color: #606266;
            margin-bottom: 5px;
        }
        .info-value {
            font-size: 16px;
            font-weight: 500;
            color: #303133;
        }
        .profit-positive {
            color: #F56C6C;
        }
        .profit-negative {
            color: #67C23A;
        }
        .chart-section {
            margin-bottom: 30px;
        }
        .chart-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #409EFF;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            margin-bottom: 30px;
        }
        .table-section {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        th {
            background-color: #f5f7fa;
            font-weight: 600;
            color: #606266;
        }
        tr:hover {
            background-color: #f9f9f9;
        }
        .back-btn {
            margin-top: 20px;
            padding: 8px 16px;
            background-color: #409EFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .back-btn:hover {
            background-color: #66b1ff;
        }
        .test-btn {
            margin: 10px;
            padding: 8px 16px;
            background-color: #67C23A;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-btn:hover {
            background-color: #85ce61;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>基金详情测试</h1>
        <button class="test-btn" onclick="loadFundDetail('025209')">测试基金 025209</button>
        <button class="test-btn" onclick="loadFundDetail('000001')">测试基金 000001</button>
        
        <div id="fundInfo" style="display: none;">
            <!-- 基金基本信息 -->
            <div class="info-section">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">基金代码</div>
                        <div class="info-value" id="fundCode"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">基金名称</div>
                        <div class="info-value" id="fundName"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">估值时间</div>
                        <div class="info-value" id="nowTime"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">估值涨跌幅</div>
                        <div class="info-value" id="forecastGrowth"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">日涨幅</div>
                        <div class="info-value" id="dayOfGrowth"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">当前净值</div>
                        <div class="info-value" id="currentNetValue"></div>
                    </div>
                </div>
            </div>
            
            <!-- 净值走势图表 -->
            <div class="chart-section">
                <div class="chart-title">净值走势图</div>
                <div class="chart-container" id="navChart"></div>
            </div>
            
            <!-- 涨跌幅图表 -->
            <div class="chart-section">
                <div class="chart-title">日涨跌幅走势图</div>
                <div class="chart-container" id="growthChart"></div>
            </div>
            
            <!-- 历史净值表格 -->
            <div class="table-section">
                <h2 style="font-size: 18px; margin-bottom: 15px; color: #409EFF;">历史净值数据</h2>
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>单位净值</th>
                            <th>累计净值</th>
                            <th>日涨跌幅</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            
            <button class="back-btn" onclick="window.close()">关闭</button>
        </div>
        
        <div id="loading" style="display: none; padding: 20px; text-align: center;">
            <p>加载中...</p>
        </div>
        
        <div id="error" style="display: none; padding: 20px; color: red;">
            <p>加载失败，请稍后重试</p>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let navChart = null;
        let growthChart = null;
        
        function showLoading() {
            document.getElementById('fundInfo').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }
        
        function showError() {
            document.getElementById('fundInfo').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }
        
        function showFundInfo() {
            document.getElementById('fundInfo').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
        }
        
        async function loadFundDetail(fundCode) {
            try {
                showLoading();
                console.log('开始获取基金历史净值数据:', fundCode);
                
                // 获取基金历史净值数据
                const response = await axios.get(`${API_BASE_URL}/api/funds/${fundCode}/history`);
                console.log('获取数据成功:', response.data);
                
                const fundData = response.data;
                const fundInfo = fundData.fund_info;
                const historyData = fundData.history_data;
                
                console.log('基金信息:', fundInfo);
                console.log('历史数据:', historyData);
                
                // 填充基金基本信息
                document.getElementById('fundCode').textContent = fundInfo.fund_code || fundCode;
                document.getElementById('fundName').textContent = fundInfo.fund_name || 'N/A';
                document.getElementById('nowTime').textContent = fundInfo.now_time || 'N/A';
                
                const forecastGrowthEl = document.getElementById('forecastGrowth');
                forecastGrowthEl.textContent = fundInfo.forecast_growth || 'N/A';
                forecastGrowthEl.className = 'info-value ' + (fundInfo.forecast_growth && !fundInfo.forecast_growth.includes('-') ? 'profit-positive' : 'profit-negative');
                
                const dayOfGrowthEl = document.getElementById('dayOfGrowth');
                dayOfGrowthEl.textContent = fundInfo.day_of_growth || 'N/A';
                dayOfGrowthEl.className = 'info-value ' + (fundInfo.day_of_growth && !fundInfo.day_of_growth.includes('-') ? 'profit-positive' : 'profit-negative');
                
                document.getElementById('currentNetValue').textContent = fundInfo.current_net_value || 'N/A';
                
                // 填充历史净值表格
                const tableBody = document.querySelector('#historyTable tbody');
                tableBody.innerHTML = '';
                
                historyData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.date}</td>
                        <td>${item.unit_nav}</td>
                        <td>${item.cumulative_nav}</td>
                        <td class="${item.daily_growth && !item.daily_growth.includes('-') ? 'profit-positive' : 'profit-negative'}">
                            ${item.daily_growth}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // 准备图表数据
                const dates = historyData.map(item => item.date).reverse();
                const unitNavs = historyData.map(item => parseFloat(item.unit_nav)).reverse();
                const growthRates = historyData.map(item => {
                    const rate = item.daily_growth.replace('%', '');
                    return parseFloat(rate);
                }).reverse();
                
                // 初始化净值走势图
                if (!navChart) {
                    navChart = echarts.init(document.getElementById('navChart'));
                }
                const navOption = {
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            return params[0].name + '<br/>' +
                                   params[0].seriesName + ': ' + params[0].value;
                        }
                    },
                    xAxis: {
                        type: 'category',
                        data: dates,
                        axisLabel: {
                            rotate: 45,
                            interval: Math.floor(dates.length / 10)
                        }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: {
                            formatter: '{value}'
                        }
                    },
                    series: [{
                        name: '单位净值',
                        type: 'line',
                        data: unitNavs,
                        smooth: true,
                        lineStyle: {
                            color: '#409EFF'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0, color: 'rgba(64, 158, 255, 0.3)'},
                                {offset: 1, color: 'rgba(64, 158, 255, 0.1)'}
                            ])
                        }
                    }]
                };
                navChart.setOption(navOption);
                
                // 初始化涨跌幅走势图
                if (!growthChart) {
                    growthChart = echarts.init(document.getElementById('growthChart'));
                }
                const growthOption = {
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            return params[0].name + '<br/>' +
                                   params[0].seriesName + ': ' + params[0].value + '%';
                        }
                    },
                    xAxis: {
                        type: 'category',
                        data: dates,
                        axisLabel: {
                            rotate: 45,
                            interval: Math.floor(dates.length / 10)
                        }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: {
                            formatter: '{value}%'
                        }
                    },
                    series: [{
                        name: '日涨跌幅',
                        type: 'bar',
                        data: growthRates,
                        itemStyle: {
                            color: function(params) {
                                return params.value >= 0 ? '#F56C6C' : '#67C23A';
                            }
                        }
                    }]
                };
                growthChart.setOption(growthOption);
                
                showFundInfo();
                console.log('基金详情加载完成');
            } catch (error) {
                console.error('获取基金历史净值失败:', error);
                showError();
            }
        }
        
        // 响应窗口大小变化
        window.addEventListener('resize', function() {
            if (navChart) navChart.resize();
            if (growthChart) growthChart.resize();
        });
    </script>
</body>
</html>