# 天天基金网API文档

## 1. API概述

天天基金网提供了多个公开的API接口，用于获取基金的实时估值、历史净值、基本信息等数据。本文档将详细介绍这些API接口的使用方法和参数说明。

## 2. API详细说明

### 2.1 实时估值接口

#### 2.1.1 请求信息

- **API URL**: `http://fundgz.1234567.com.cn/js/{fund_code}.js`
- **请求方法**: GET
- **请求参数**:
  | 参数名 | 类型 | 必选 | 描述 |
  |-------|------|------|------|
  | fund_code | string | 是 | 基金代码 |

- **请求头**:
  | 头部字段 | 值 | 说明 |
  |---------|-----|------|
  | User-Agent | Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36 | 浏览器标识 |
  | Referer | http://fund.eastmoney.com/ | 来源页面 |

#### 2.1.2 响应信息

- **响应格式**: JSONP
- **响应示例**:
  ```javascript
  jsonpgz({
    "fundcode":"000001",
    "name":"华夏成长混合",
    "jzrq":"2024-01-12",
    "dwjz":"1.2345",
    "gsz":"1.2456",
    "gszzl":"0.90",
    "gztime":"2024-01-12 15:00"
  });
  ```

- **返回字段说明**:
  | 字段名 | 类型 | 描述 |
  |-------|------|------|
  | fundcode | string | 基金代码 |
  | name | string | 基金名称 |
  | jzrq | string | 净值日期 |
  | dwjz | string | 单位净值 |
  | gsz | string | 估值 |
  | gszzl | string | 估值涨跌幅（百分比） |
  | gztime | string | 估值时间 |

### 2.2 历史净值接口

#### 2.2.1 请求信息

- **API URL**: `http://fund.eastmoney.com/f10/F10DataApi.aspx?type=lsjz&code={fund_code}&page={page}&sdate={start_date}&edate={end_date}`
- **请求方法**: GET
- **请求参数**:
  | 参数名 | 类型 | 必选 | 描述 |
  |-------|------|------|------|
  | type | string | 是 | 固定值：lsjz |
  | code | string | 是 | 基金代码 |
  | page | string | 否 | 页码，默认1 |
  | sdate | string | 否 | 开始日期（YYYY-MM-DD） |
  | edate | string | 否 | 结束日期（YYYY-MM-DD） |

#### 2.2.2 响应信息

- **响应格式**: HTML（包含表格数据）
- **返回数据**:
  表格形式的历史净值数据，包含以下字段：
  - `净值日期`: 基金净值的日期
  - `单位净值`: 基金的单位净值
  - `累计净值`: 基金的累计净值
  - `日增长率`: 基金的日涨跌幅
  - `申购状态`: 基金的申购状态（开放/关闭）
  - `赎回状态`: 基金的赎回状态（开放/关闭）
  - `分红送配`: 基金的分红送配信息
- **状态**: 正常（测试通过）

### 2.3 基本信息接口

#### 2.3.1 请求信息

- **API URL**: `http://fund.eastmoney.com/pingzhongdata/{fund_code}.js`
- **请求方法**: GET
- **请求参数**:
  | 参数名 | 类型 | 必选 | 描述 |
  |-------|------|------|------|
  | fund_code | string | 是 | 基金代码 |

#### 2.3.2 响应信息

- **响应格式**: JavaScript（包含多个变量定义）
- **返回数据**:
  基金基本信息、持仓结构、行业配置、净值走势等详细数据
- **主要返回字段**:
  - `fS_name`: 基金名称
  - `fS_code`: 基金代码
  - `fund_sourceRate`: 原费率
  - `fund_Rate`: 现费率
  - `fund_minsg`: 最小申购金额
  - `stockCodes`: 基金持仓股票代码
  - `zqCodes`: 基金持仓债券代码
- **状态**: 正常（测试通过）
- **注意**: 测试中未找到近30天涨跌幅相关的字段，可能需要通过计算历史净值数据来获得

### 2.4 基金公司列表接口

#### 2.4.1 请求信息

- **API URL**: `http://fund.eastmoney.com/Data/FundRankList.aspx?t=1&pi=1&pn=50`
- **请求方法**: GET
- **请求参数**:
  | 参数名 | 类型 | 必选 | 描述 |
  |-------|------|------|------|
  | t | string | 是 | 固定值：1 |
  | pi | string | 否 | 页码，默认1 |
  | pn | string | 否 | 每页数量，默认50 |

#### 2.4.2 响应信息

- **响应格式**: HTML
- **返回数据**:
  基金公司列表数据
- **状态**: 失败（403 Forbidden）
- **原因**: 可能需要额外的请求头或Cookie验证

### 2.5 基金排行接口

#### 2.5.1 请求信息

- **API URL**: `http://fund.eastmoney.com/Data/FundRankList.aspx?t={type}&pi={page}&pn={page_size}`
- **请求方法**: GET
- **请求参数**:
  | 参数名 | 类型 | 必选 | 描述 |
  |-------|------|------|------|
  | t | string | 是 | 基金类型：1(股票型), 2(混合型), 3(债券型), 4(指数型), 5(QDII), 6(货币型), 7(理财型) |
  | pi | string | 否 | 页码，默认1 |
  | pn | string | 否 | 每页数量，默认50 |

#### 2.5.2 响应信息

- **响应格式**: HTML
- **返回数据**:
  基金排行榜数据
- **状态**: 失败（403 Forbidden）
- **原因**: 可能需要额外的请求头或Cookie验证

### 2.6 基金搜索接口

#### 2.6.1 请求信息

- **API URL**: `http://fundsuggest.eastmoney.com/FundSearch/api/FundSearchSuggest?key={keyword}`
- **请求方法**: GET
- **请求参数**:
  | 参数名 | 类型 | 必选 | 描述 |
  |-------|------|------|------|
  | key | string | 是 | 搜索关键词（基金代码或名称） |

#### 2.6.2 响应信息

- **响应格式**: JSON
- **返回数据**:
  搜索结果列表，包含基金代码、名称等信息
- **状态**: 失败（404 Not Found）
- **原因**: API地址可能已更改

## 3. 代码使用示例

### 3.1 简化使用示例

项目中提供了完整的测试脚本 `test_api_fields.py`，包含了所有API接口的测试代码。以下是核心使用方法：

1. **实时估值接口**：使用 `test_real_time_valuation()` 函数测试
2. **历史净值接口**：使用 `test_historical_net_value()` 函数测试
3. **基本信息接口**：使用 `test_basic_info()` 函数测试

### 3.2 项目集成示例

在项目的 `fund_service.py` 文件中，API调用的核心逻辑如下：

```python
# 使用天天基金网的API获取实时估值
url = f"http://fundgz.1234567.com.cn/js/{fund_code}.js"
response = self.session.get(url, headers={
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36",
    "Referer": "http://fund.eastmoney.com/"
}, timeout=10, verify=False)

# 解析响应数据
if response.status_code == 200:
    # 去除回调函数包装
    content = response.text
    if content.startswith('jsonpgz(') and content.endswith(')'):
        content = content[8:-1]
        api_data = json.loads(content)
        # 提取估值数据
        forecast_growth = api_data.get('gszzl', 'N/A')
        current_net_value = float(api_data.get('dwjz', '0.0'))
```

## 4. 注意事项

1. **API限制**: 该API为天天基金网公开接口，可能存在访问频率限制，建议合理控制请求频率。

2. **响应格式**: 响应数据为JSONP格式，需要去除`jsonpgz()`包装后才能解析为JSON。

3. **数据更新时间**: 估值数据通常在交易日的9:30-15:00期间实时更新，非交易时间可能返回前一交易日的数据。

4. **网络异常处理**: 由于是外部API，可能会受到网络波动影响，建议添加异常处理机制。

5. **数据准确性**: 估值数据仅供参考，实际净值以基金公司公布的数据为准。

## 5. 项目中使用的API场景

在项目中，天天基金网API主要用于以下场景：

1. **获取基金实时估值**: 在`fund_service.py`中，使用该API获取基金的实时估值数据，用于计算基金的实时涨跌幅。

2. **计算盈亏**: 在`funds.py`中，使用该API获取的估值数据计算基金的实时盈亏。

3. **批量获取基金数据**: 在`get_multiple_funds_data`方法中，通过多线程批量获取多个基金的数据。

## 6. 故障排查

### 6.1 常见问题

1. **JSON解析失败**: 可能是响应格式发生变化，需要检查响应内容是否仍然为`jsonpgz()`包装的格式。

2. **API无响应**: 可能是网络问题或API暂时不可用，建议添加重试机制。

3. **数据为空**: 可能是基金代码不存在或基金数据未更新，建议检查基金代码的正确性。

### 6.2 排查方法

1. **检查请求URL**: 确保基金代码格式正确，URL拼接无误。

2. **查看响应内容**: 打印响应状态码和响应内容，确认API是否正常返回数据。

3. **检查解析逻辑**: 确保JSONP解析逻辑正确，能够处理不同格式的响应。

4. **添加异常处理**: 对网络请求和JSON解析过程添加异常处理，提高代码的健壮性。

## 7. 总结

天天基金网提供了多个公开的API接口，为项目提供了丰富的基金数据获取能力：

1. **实时估值接口**：用于获取基金的实时估值、涨跌幅等数据，是项目中最常用的接口。
2. **历史净值接口**：用于获取基金的历史净值数据，可用于分析基金的历史表现。
3. **基本信息接口**：用于获取基金的基本信息、持仓结构、行业配置等详细数据。
4. **基金公司列表接口**：用于获取基金公司的列表数据。
5. **基金排行接口**：用于获取不同类型基金的排行榜数据。
6. **基金搜索接口**：用于根据关键词搜索基金。

通过合理使用这些API接口，可以实现基金数据的实时更新、盈亏计算、历史数据分析等功能，提升用户体验。

在使用过程中，需要注意API的使用限制和数据的准确性，同时添加适当的异常处理机制，确保代码的稳定性和可靠性。对于不同的业务场景，可以选择合适的API接口来获取所需的数据。

## 8. API测试脚本

### 8.1 测试脚本介绍

为了验证API接口的可用性和返回字段，项目中提供了一个测试脚本 `test_api_fields.py`，用于自动测试各个API接口并分析其返回数据。

### 8.2 测试脚本使用方法

1. **安装依赖**:
   ```bash
   pip install requests beautifulsoup4
   ```

2. **运行测试脚本**:
   ```bash
   python test_api_fields.py
   ```

### 8.3 测试结果分析

#### 8.3.1 测试环境

- **测试日期**: 2026-02-04
- **测试基金代码**: 000001（华夏成长混合）

#### 8.3.2 测试结果汇总

| API接口 | 状态 | 描述 |
|--------|------|------|
| 实时估值接口 | 正常 | 成功获取基金实时估值数据 |
| 历史净值接口 | 正常 | 成功获取基金历史净值数据 |
| 基本信息接口 | 正常 | 成功获取基金基本信息数据 |
| 基金公司列表接口 | 失败 | 403 Forbidden，可能需要额外验证 |
| 基金排行接口 | 失败 | 403 Forbidden，可能需要额外验证 |
| 基金搜索接口 | 失败 | 404 Not Found，API地址可能已更改 |

#### 8.3.3 可用API接口分析

1. **实时估值接口**
   - **用途**: 获取基金的实时估值、涨跌幅等数据
   - **可靠性**: 高
   - **推荐使用**: 是

2. **历史净值接口**
   - **用途**: 获取基金的历史净值数据，用于分析基金的历史表现
   - **可靠性**: 高
   - **推荐使用**: 是

3. **基本信息接口**
   - **用途**: 获取基金的基本信息、费率、持仓结构等详细数据
   - **可靠性**: 高
   - **推荐使用**: 是
   - **注意**: 未找到近30天涨跌幅相关字段

### 8.4 测试脚本功能

- **自动测试**: 自动测试所有API接口的可用性
- **字段分析**: 分析API接口返回的字段结构和数据类型
- **结果报告**: 生成详细的测试结果报告
- **异常处理**: 包含完善的异常处理机制

### 8.5 测试脚本代码

测试脚本代码位于 `test_api_fields.py` 文件中，包含以下主要功能：

- `test_real_time_valuation()`: 测试实时估值接口
- `test_historical_net_value()`: 测试历史净值接口
- `test_basic_info()`: 测试基本信息接口
- `test_fund_company_list()`: 测试基金公司列表接口
- `test_fund_ranking()`: 测试基金排行接口
- `test_fund_search()`: 测试基金搜索接口
- `run_all_tests()`: 运行所有测试并生成报告